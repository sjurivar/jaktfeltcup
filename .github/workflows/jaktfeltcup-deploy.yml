name: Deploy Jaktfeltcup til hjellum.net

on:
  push:
    branches:
      - main
      - staging

env:
  PROD_DIR: /customers/d/9/c/csj1wp95j/webroots/r1415789/
  STAGING_DIR: /customers/d/9/c/csj1wp95j/webroots/r1415789/staging/jaktfeltcup/

jobs:
  ftp-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Sjekk ut koden
        uses: actions/checkout@v4

      - name: Forbered deployment package
        run: |
          # Opprett deployment directory
          mkdir -p deploy
          
          # Kopier nÃ¸dvendige filer
          cp -r views deploy/
          cp -r src deploy/
          cp -r config deploy/
          cp -r data deploy/
          cp -r handlers deploy/
          cp -r database deploy/
          cp -r admin deploy/
          cp -r scripts deploy/
          cp -r assets deploy/
          cp index.php deploy/
          cp .htaccess deploy/
          
          # Ensure .htaccess files are copied (they might be hidden)
          find admin -name ".htaccess" -exec cp {} deploy/{} \; 2>/dev/null || true
          find scripts -name ".htaccess" -exec cp {} deploy/{} \; 2>/dev/null || true
          
          # Note: Production uses its own config.php file
          # No need to copy production config
          
          # Opprett .htaccess for produksjon
          cat > deploy/.htaccess << 'EOF'
          RewriteEngine On
          
          # Redirect all requests to index.php
          RewriteCond %{REQUEST_FILENAME} !-f
          RewriteCond %{REQUEST_FILENAME} !-d
          RewriteRule ^(.*)$ index.php [QSA,L]
          
          # Security headers
          Header always set X-Content-Type-Options nosniff
          Header always set X-Frame-Options DENY
          Header always set X-XSS-Protection "1; mode=block"
          
          # Cache static files
          <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg)$">
              ExpiresActive On
              ExpiresDefault "access plus 1 month"
          </FilesMatch>
          EOF
          
          # Debug: List what was copied to deploy directory
          echo "=== DEBUG: Files in deploy directory ==="
          find deploy -type f | head -20
          echo "=== DEBUG: Admin directory contents ==="
          ls -la deploy/admin/ || echo "Admin directory not found in deploy"
          ls -la deploy/admin/database/ || echo "Admin/database directory not found in deploy"
          
          # Opprett deployment info
          echo "Deployed: $(date)" > deploy/DEPLOY_INFO.txt
          echo "Commit: ${{ github.sha }}" >> deploy/DEPLOY_INFO.txt
          echo "Branch: ${{ github.ref_name }}" >> deploy/DEPLOY_INFO.txt
          echo "Environment: ${{ github.ref_name == 'main' && 'Production' || 'Staging' }}" >> deploy/DEPLOY_INFO.txt

      - name: Sett opp serverdir for riktig miljÃ¸
        id: vars
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "dir=${PROD_DIR}" >> $GITHUB_OUTPUT
            echo "env=Production" >> $GITHUB_OUTPUT
          elif [[ "${GITHUB_REF_NAME}" == "staging" ]]; then
            echo "dir=${STAGING_DIR}" >> $GITHUB_OUTPUT
            echo "env=Staging" >> $GITHUB_OUTPUT
          fi

      - name: Deploy til hjellum.net
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ vars.FTP_SERVER }}
          username: ${{ vars.FTP_USER }}
          password: ${{ vars.FTP_PASSWORD }}
          server-dir: ${{ steps.vars.outputs.dir }}
          local-dir: deploy/
          protocol: ftp
          timeout: 600
          exclude: |
            **/.git*
            **/*.md
            **/DEPLOY_INFO.txt
            **/env.example
            **/deploy.sh
            **/test.php

      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… Jaktfeltcup deployment successful!"
          echo "ğŸŒ Environment: ${{ steps.vars.outputs.env }}"
          echo "ğŸ“ Directory: ${{ steps.vars.outputs.dir }}"
          echo "ğŸ“… Deployed: $(date)"
          echo "ğŸ”— URL: https://hjellum.net/jaktfeltcup/"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "âŒ Jaktfeltcup deployment failed!"
          echo "Check the logs above for details."
          echo "Environment: ${{ steps.vars.outputs.env }}"
